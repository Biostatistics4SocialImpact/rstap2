---
title: "STAP DND Mixed Effects"
author: "Adam Peterson"
date: "3/6/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r cars}
set.seed(24)
num_subj <- 400
num_bef <- 10
Z <- rep(rbinom(n = num_subj, size = 1, prob = .5),3)
delta <- -.5
theta_s <- .5
alpha <- 22
beta <- 1.2
beta_bar <- 1
sigma <- 1
dists_1 <- matrix(rexp(n = num_subj*num_bef,
                       rate = 1),
                  nrow = num_subj,
                  ncol = num_bef)
dists_2 <- matrix(rexp(n = num_subj*num_bef,
                       rate = 1),
                  nrow = num_subj,
                  ncol = num_bef)
dists_3 <- matrix(rexp(n= num_subj*num_bef,
                       rate = .5),
                  nrow = num_subj, ncol = num_bef)
dists <- rbind(dists_1,dists_2,dists_3)
colnames(dists) <- stringr::str_c("BEF_",1:ncol(dists))
dists <- as_tibble(dists)

dists <- dists %>% mutate(id=expand.grid(subj=1:num_subj,time = 1:3)$subj,
                         time = expand.grid(1:num_subj,time = 1:3)$time) %>%
    gather(contains("BEF"),key = "BEF", value="Distance") %>% 
    filter(Distance<=5)

X <- dists %>% group_by(id,time) %>% summarise(Exposure = sum(exp(-Distance/theta_s)))
X_bar <- X %>% group_by(id) %>% summarise(MN_Exposure = mean(Exposure))
X_bar <- X_bar %>% mutate(subj_int = rnorm(n = n(),mean = 0,sd = 1.2))

X_diff <- X %>% left_join(X_bar,by='id') %>% mutate(X_diff = Exposure - MN_Exposure)


y <- alpha + Z * delta + beta*X_diff$X_diff + X_diff$MN_Exposure*beta_bar + X_diff$subj_int +  rnorm(n = num_subj*3,
                         mean = 0,
                         sd = sigma)

Z <- matrix(Z,ncol=1)
```

```{r}
W <- t(subj_mat1)

```

